{% extends 'base.html.twig' %}
{% block title %}SHOPS - InnoMall{% endblock %}
{% block stylesheets %}
   
    <link rel="stylesheet" href="{{ asset('css/shops.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

{% endblock %}

{% block content %}
    <div class="shops-container">
        <form method="GET" action="{{ path('app_shops') }}">
    <!-- Search Filter -->
    <div class="search-filter">
        <input type="text" name="search" placeholder="Search shops..." value="{{ app.request.get('search') }}">
    </div>

    <!-- Category Filter -->
    <div class="filter-group">
        <h3><i class="fas fa-tags"></i> Categories</h3>
        <ul class="filter-options">
            {% for category in categories %}
                <li>
                    <label>
                        <input type="checkbox" name="categories[]" value="{{ category.nom }}"
                            {% if category.nom in app.request.get('categories', []) %} checked {% endif %}>
                        {{ category.nom }}
                    </label>
                </li>
            {% endfor %}
        </ul>
    </div>

    <!-- Rating Filter -->
    <div class="filter-group">
        <h3><i class="fas fa-star"></i> Rating</h3>
        <div class="rating-filter">
            {% for i in [5,4,3,2,1] %}
                <div class="rating-option">
                    <label>
                        <input type="radio" name="rating" value="{{ i }}" {% if app.request.get('rating') == i|striptags %} checked {% endif %}>
                        <div class="rating-stars-filter">
                            {% for j in 1..5 %}
                                <i class="{{ j <= i ? 'fas' : 'far' }} fa-star"></i>
                            {% endfor %}
                        </div>
                    </label>
                </div>
            {% endfor %}
        </div>
    </div>

    <!-- Bouton de soumission -->
    <button type="submit" class="filter-reset">
        <i class="fas fa-search"></i> Apply Filters
    </button>
   
</form>

            
          
        
        
        <!-- Shops Grid -->
        <div class="shops-grid">
            {% for shopOwner in shopOwners %}
                <div class="shop-card">
                    <div class="shop-header">
                        <h3>{{ shopOwner.nom|upper }} {{ shopOwner.prenom is defined ? shopOwner.prenom|upper : '' }}</h3>
                       <div class="shop-rating">
    {% set averageRating = feedback_repo.getAverageRatingValue(shopOwner) %}
    {% set ratingCount = feedback_repo.countByShop(shopOwner) %}
    <div class="stars">
        {% for i in 1..5 %}
            {% if i <= averageRating %}
                <i class="fas fa-star"></i> {# full star #}
            {% elseif i - 0.5 <= averageRating %}
                <i class="fas fa-star-half-alt"></i> {# half star #}
            {% else %}
                <i class="far fa-star"></i> {# empty star #}
            {% endif %}
        {% endfor %}
    </div>
    <span class="rating-count">({{ ratingCount }} reviews)</span>
</div>

                    </div>
                    <div class="shop-body">
                        <p class="shop-description">
                            {{ shopOwner.description ?? 'No description available' }}
                        </p>
                        
                        <div class="shop-details">
                            <div class="detail-item">
                                <i class="fas fa-phone"></i>
                                <span>{{ shopOwner.telephone ?? 'No phone' }} +216 55487955</span>
                            </div>
                            <div class="detail-item">
                                <i class="fas fa-clock"></i>
                                <span>8 AM to 9 PM</span>
                            </div>
                        </div>
                        
                        <div class="shop-promo">
                            <strong>Category:</strong> {{ shopOwner.categorie ? shopOwner.categorie.nom : 'Not specified' }}
                        </div>
                        
                        <a href="#" class="shop-website" target="_blank">
                            {{ shopOwner.website ?? '' }} www.{{shopOwner.nom}}.com
                        </a>
                        
           <!-- Rating Form -->
<div class="rating-form">
    <h4>Rate this shop:</h4>

    {% set rating = feedback_repo.findOneByUserAndShop(fixedUser, shopOwner) %}

    {% if rating %}
        <div class="star-rating">
            {% for i in 1..5 %}
                {% if i <= rating.rating %}
                    <span class="star"><i class="fas fa-star" style="color: gold;"></i></span>
                {% else %}
                    <span class="star"><i class="fas fa-star" style="color: rgb(241, 238, 238);"></i></span>
                {% endif %}
            {% endfor %}
        </div>

        <form method="post" action="{{ path('delete_rating', {'shopId': shopOwner.id}) }}" style="display:inline;">
            <button type="submit" class="delete-btn" title="Delete Rating" style="background-color:white; border:none">
                <i class="fas fa-trash" style="color: rgb(238, 58, 58); background-color:white;"></i>
            </button>
        </form>

    {% else %}

     {% if feedback_forms[shopOwner.id] is defined %}
    {{ form_start(feedback_forms[shopOwner.id], {
        'attr': {'novalidate': 'novalidate'},
        'name': 'feedback_form_' ~ shopOwner.id
    }) }}

    {# Hide label visually #}
    {{ form_label(feedback_forms[shopOwner.id].rating, null, {'label_attr': {'style': 'display:none;'}}) }}

    <div class="star-rating">
        {% for i in 1..5 %}
            <input type="radio"
                   id="star{{ i }}-{{ shopOwner.id }}"
                   name="{{ feedback_forms[shopOwner.id].rating.vars.full_name }}"
                   value="{{ i }}"
                   {% if feedback_forms[shopOwner.id].rating.vars.value == i %} checked {% endif %}>
            <label for="star{{ i }}-{{ shopOwner.id }}">&#9733;</label>
        {% endfor %}
    </div>

    
     {# Show global errors (like missing rating if not submitted) #}
 {% if feedback_forms[shopOwner.id].rating.vars.errors|length > 0 %}
    <div class="tooltip-error" style="border: 2px solid red;">
        {{ form_errors(feedback_forms[shopOwner.id].rating) }}
    </div>
{% endif %}


    <button type="submit" class="submit-rating">Add Rating</button>
    {{ form_end(feedback_forms[shopOwner.id], {'render_rest': true}) }}
{% endif %}



    {% endif %}
   
</div>            
                <!-- View Product Button -->
<div class="view-product-container">
    <form action="{{ path('shop_products', {'shopId': shopOwner.id}) }}" method="GET">
        <button type="submit" class="view-product-btn">View Products</button>
    </form>
</div>

                    </div>
                        
                </div>
            {% endfor %}
        </div>
    </div>

     <script>
      

        // Star rating interaction
        document.querySelectorAll('.star-input input[type="radio"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const stars = this.closest('.star-rating').querySelectorAll('label');
                stars.forEach((star, index) => {
                    star.querySelector('i').className = index < this.value ? 'fas fa-star' : 'far fa-star';
                });
            });
        });
    </script>
{% endblock %}