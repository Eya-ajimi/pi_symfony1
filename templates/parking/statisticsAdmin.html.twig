{% extends 'backend/base.html.twig' %}

{% block title %}Parking Statistics | Admin{% endblock %}

{% block stylesheets %}
    <link rel="stylesheet" href="{{ asset('assets/css2/css/styles.min.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

{% endblock %}

{% block content %}
    <div class="card" style="margin-top: 100px;">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 class="card-title">
                    <i class="fas fa-chart-pie me-2"></i>Parking Statistics
                </h4>
                <div>
                    <button class="btn btn-primary me-2" onclick="window.print()">
                        <i class="fas fa-print me-2"></i>Print
                    </button>
                    <button class="btn btn-success">
                        <i class="fas fa-download me-2"></i>Export
                    </button>
                </div>
            </div>

            {# Summary Cards #}
            <div class="row mb-4">
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="card h-100 border-primary">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="me-3 bg-primary bg-opacity-10 p-3 rounded">
                                    <i class="fas fa-parking text-primary fs-4"></i>
                                </div>
                                <div>
                                    <h6 class="mb-1">Total Spots</h6>
                                    <h4 class="mb-0">{{ total_spots }}</h4>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="card h-100 border-success">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="me-3 bg-success bg-opacity-10 p-3 rounded">
                                    <i class="fas fa-check-circle text-success fs-4"></i>
                                </div>
                                <div>
                                    <h6 class="mb-1">Available</h6>
                                    <h4 class="mb-0">{{ available_spots }}</h4>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="card h-100 border-warning">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="me-3 bg-warning bg-opacity-10 p-3 rounded">
                                    <i class="fas fa-percentage text-warning fs-4"></i>
                                </div>
                                <div>
                                    <h6 class="mb-1">Occupancy Rate</h6>
                                    <h4 class="mb-0">{{ occupancy_rate }}%</h4>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="card h-100 border-info">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="me-3 bg-info bg-opacity-10 p-3 rounded">
                                    <i class="fas fa-calendar-check text-info fs-4"></i>
                                </div>
                                <div>
                                    <h6 class="mb-1">Active Reservations</h6>
                                    <h4 class="mb-0">{{ active_reservations }}</h4>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {# Revenue Cards #}
            <div class="row mb-4">
                <div class="col-md-6 mb-3">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title mb-3">
                                <i class="fas fa-money-bill-wave me-2"></i>Revenue Summary
                            </h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="bg-danger bg-opacity-10 p-3 rounded me-3">
                                            <i class="fas fa-coins text-danger fs-4"></i>
                                        </div>
                                        <div>
                                            <h6 class="mb-1">Today's Revenue</h6>
                                            <h4 class="mb-0">{{ daily_revenue }} TND</h4>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="bg-secondary bg-opacity-10 p-3 rounded me-3">
                                            <i class="fas fa-chart-line text-secondary fs-4"></i>
                                        </div>
                                        <div>
                                            <h6 class="mb-1">Monthly Revenue</h6>
                                            <h4 class="mb-0">{{ monthly_revenue }} TND</h4>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title mb-3">
                                <i class="fas fa-chart-pie me-2"></i>Overall Occupancy
                            </h5>
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar bg-{{ occupancy_rate > 80 ? 'danger' : occupancy_rate > 50 ? 'warning' : 'success' }}" 
                                     role="progressbar" 
                                     style="width: {{ occupancy_rate }}%" 
                                     aria-valuenow="{{ occupancy_rate }}" 
                                     aria-valuemin="0" 
                                     aria-valuemax="100">
                                    {{ occupancy_rate }}%
                                </div>
                            </div>
                            <div class="mt-2 d-flex justify-content-between">
                                <small class="text-muted">0%</small>
                                <small class="text-muted">100%</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {# Floor Statistics #}
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title mb-4">
                        <i class="fas fa-layer-group me-2"></i>Floor Statistics
                    </h5>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Floor</th>
                                    <th>Total Spots</th>
                                    <th>Available</th>
                                    <th>Occupied</th>
                                    <th>Occupancy Rate</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for floor_stat in floor_stats %}
                                    <tr>
                                        <td>
                                            <strong>{{ floor_stat.floor }}</strong>
                                        </td>
                                        <td>{{ floor_stat.total }}</td>
                                        <td>
                                            <span class="badge bg-success">{{ floor_stat.available }}</span>
                                        </td>
                                        <td>
                                            <span class="badge bg-warning">{{ floor_stat.occupied }}</span>
                                        </td>
                                        <td>
                                            <div class="progress" style="height: 20px;">
                                                <div class="progress-bar bg-{{ floor_stat.occupancy_rate > 80 ? 'danger' : floor_stat.occupancy_rate > 50 ? 'warning' : 'success' }}" 
                                                     role="progressbar" 
                                                     style="width: {{ floor_stat.occupancy_rate }}%" 
                                                     aria-valuenow="{{ floor_stat.occupancy_rate }}" 
                                                     aria-valuemin="0" 
                                                     aria-valuemax="100">
                                                    {{ floor_stat.occupancy_rate }}%
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            {% if floor_stat.occupancy_rate > 80 %}
                                                <span class="badge bg-danger">High Occupancy</span>
                                            {% elseif floor_stat.occupancy_rate > 50 %}
                                                <span class="badge bg-warning">Moderate</span>
                                            {% else %}
                                                <span class="badge bg-success">Good Availability</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            {# Floor Comparison Chart #}
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title mb-4">
                        <i class="fas fa-chart-bar me-2"></i>Floor Comparison
                    </h5>
                    <div class="chart-container" style="height: 300px;">
                        <canvas id="floorComparisonChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Floor Comparison Chart
            const floorCtx = document.getElementById('floorComparisonChart');
            if (floorCtx) {
                const floorLabels = {{ floor_stats|map(stat => stat.floor)|json_encode|raw }};
                const availableData = {{ floor_stats|map(stat => stat.available)|json_encode|raw }};
                const occupiedData = {{ floor_stats|map(stat => stat.occupied)|json_encode|raw }};
                
                new Chart(floorCtx, {
                    type: 'bar',
                    data: {
                        labels: floorLabels,
                        datasets: [
                            {
                                label: 'Available Spots',
                                backgroundColor: '#28a745',
                                data: availableData
                            },
                            {
                                label: 'Occupied Spots',
                                backgroundColor: '#fd7e14',
                                data: occupiedData
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                stacked: false,
                                grid: {
                                    display: false
                                }
                            },
                            y: {
                                stacked: false,
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 5
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false
                            }
                        }
                    }
                });
            }
        });
    </script>
{% endblock %}