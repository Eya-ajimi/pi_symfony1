{# templates/parking/admin.html.twig #}
{% extends 'base.html.twig' %}

{% block title %}Smart Parking | Admin Dashboard
{% endblock %}

{% block stylesheets %}
	
	<link rel="stylesheet" href="{{ asset('css/parking.css') }}">
	<link rel="stylesheet" href="{{ asset('css/adminpark.css') }}">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
	<link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
{% endblock %}

{% block content %}
	<div
		class="admin-dashboard">
		{# Sidebar #}
		<div class="admin-sidebar">
			<div class="sidebar-header">
				<div class="logo">
					<i class="fas fa-parking"></i>
					<span>Smart Parking</span>
				</div>
			</div>

			<nav class="sidebar-nav">
				<ul>
					<li class="nav-item active" data-tab="parking-spots">
						<i class="fas fa-parking"></i>
						<span>Parking Spots</span>
					</li>
					<li class="nav-item" data-tab="reservations">
						<i class="fas fa-calendar-alt"></i>
						<span>Reservations</span>
					</li>
					<li class="nav-item" data-tab="stats">
						<i class="fas fa-chart-pie"></i>
						<span>Statistics</span>
					</li>
				</ul>
			</nav>
		</div>

		{# Main Content Area #}
		<div class="admin-content">
			<div class="content-header">
				<h1>
					<i class="fas fa-user-shield"></i>
					Admin Dashboard</h1>
				<div class="user-actions">
					<div class="admin-search">
						<i class="fas fa-search"></i>
						<input type="text" placeholder="Search...">
					</div>
					<div class="admin-profile">
						<span>Admin</span>
						<i class="fas fa-user-circle"></i>
					</div>
				</div>
			</div>

			{# Content Panels #}
			<div
				class="content-body">
				{# Parking Spots Management #}
				<div id="parking-spots" class="tab-panel active">
					<div class="panel-header">
						<h2>
							<i class="fas fa-parking"></i>
							Manage Parking Spots</h2>
						<a href="{{ path('admin_parking_add') }}" class="btn-primary">
							<i class="fas fa-plus"></i>
							Add Spot
						</a>
					</div>

					{# Floor Selector Card #}
					<div class="panel-card">
						<div class="card-header">
							<h3>Select Floor</h3>
						</div>
						<div class="card-body">
							<div class="floor-selector">
								<div class="floor-buttons">
									<button class="floor-btn active" onclick="loadFloorSpots(1)">Floor 1</button>
									<button class="floor-btn" onclick="loadFloorSpots(2)">Floor 2</button>
									<button class="floor-btn" onclick="loadFloorSpots(3)">Floor 3</button>
								</div>
								<div class="floor-summary">
									<span>Currently viewing:
										<strong>Floor
											<span id="currentFloorDisplay">1</span>
										</strong>
									</span>
								</div>
							</div>
						</div>
					</div>

					{# Spots List Card #}
					<div class="panel-card">
						<div class="card-header">
							<h3>Parking Spots</h3>
						</div>
						<div class="card-body">
							<div class="table-responsive">
								<table id="spotsTable" class="data-table">
									<thead>
										<tr>
											<th>ID</th>
											<th>Zone</th>
											<th>Floor</th>
											<th>Status</th>
											<th>Actions</th>
										</tr>
									</thead>
									<tbody>
										{% for spot in spots %}
											<tr>
												<td>{{ spot.zone }}{{ spot.id }}</td>
												<td>{{ spot.zone }}</td>
												<td>{{ spot.floor|replace({'Level ': ''}) }}</td>
												<td>
													<span class="status-badge {{ spot.statut == 'free' ? 'free' :
															                                                                                spot.statut == 'taken' ? 'taken' :
															                                                                                spot.statut == 'reserved' ? 'reserved' : '' }}">
														{{ spot.statut|capitalize }}
													</span>
												</td>
												<td class="action-buttons">
    <a href="{{ path('admin_parking_edit', {'id': spot.id}) }}" class="btn-edit">
        <i class="fas fa-edit"></i>
    </a>
    <a href="{{ path('admin_parking_delete', {'id': spot.id}) }}" class="btn-delete" onclick="return confirm('Are you sure you want to delete this parking spot?')">
        <i class="fas fa-trash"></i>
    </a>
</td>
											</tr>
										{% endfor %}
									</tbody>
								</table>
							</div>
						</div>
					</div>
				</div>

				{# Reservations Management #}
				<div id="reservations" class="tab-panel">
    <div class="panel-header">
        <h2>
            <i class="fas fa-calendar-alt"></i>
            Manage Reservations</h2>
        <div class="header-actions">
            <div class="date-filter">
                <input type="date" class="date-input" placeholder="Filter by date">
                <button class="btn-filter">
                    <i class="fas fa-filter"></i>
                    Filter
                </button>
            </div>
        </div>
    </div>

    {# Reservations List Card #}
    <div class="panel-card">
        <div class="card-header">
            <h3>Active Reservations</h3>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                {% if all_reservations is defined and all_reservations|length > 0 %}
                    <table id="reservationsTable" class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>User</th>
                                <th>Spot</th>
                                <th>Start Time</th>
                                <th>End Time</th>
                                <th>Status</th>
                                <th>Vehicle</th>
                                <th>Price (TND)</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for reservation in all_reservations %}
                                <tr>
                                    <td>{{ reservation.idReservation }}</td>
                                    <td>{{ reservation.idUtilisateur }}</td>
                                    <td>
                                        {% if reservation.placeParking %}
                                            {{ reservation.placeParking.zone }}{{ reservation.placeParking.id }}
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </td>
                                    <td>{{ reservation.dateReservation|date('Y-m-d H:i') }}</td>
                                    <td>{{ reservation.dateExpiration|date('Y-m-d H:i') }}</td>
                                    <td>
                                        <span class="status-badge {{ reservation.statut == 'active' ? 'free' :
                                              reservation.statut == 'expired' ? 'taken' :
                                              reservation.statut == 'cancelled' ? 'taken' : '' }}">
                                            {{ reservation.statut|capitalize }}
                                        </span>
                                    </td>
                                    <td>{{ reservation.vehicleType|capitalize }}</td>
                                    <td>{{ reservation.price }}</td>
                                    <td class="action-buttons">
                                        <a href="{{ path('admin_reservation_edit', {'id': reservation.idReservation}) }}" class="btn-edit">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <a href="{{ path('admin_reservation_delete', {'id': reservation.idReservation}) }}" class="btn-delete" onclick="return confirm('Are you sure you want to delete this reservation?')">
                                            <i class="fas fa-trash"></i>
                                        </a>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <div class="empty-state">
                        <i class="fas fa-calendar-times"></i>
                        <p>No reservations found.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

				{# Statistics Panel #}
				<div id="stats" class="tab-panel">
					<div class="panel-header">
						<h2>
							<i class="fas fa-chart-pie"></i>
							Parking Statistics</h2>
						<div class="header-actions">
							<button class="btn-primary">
								<i class="fas fa-download"></i>
								Export
							</button>
						</div>
					</div>

					{# Overview Stats Cards #}
					<div class="stats-cards">
						<div class="stat-card">
							<div class="stat-icon">
								<i class="fas fa-parking"></i>
							</div>
							<div class="stat-info">
								<h4>Total Spots</h4>
								<div class="stat-value">{{ total_spots ?? 0 }}</div>
							</div>
						</div>
						<div class="stat-card">
							<div class="stat-icon">
								<i class="fas fa-check-circle"></i>
							</div>
							<div class="stat-info">
								<h4>Available Spots</h4>
								<div class="stat-value">{{ available_spots ?? 0 }}</div>
							</div>
						</div>
						<div class="stat-card">
							<div class="stat-icon">
								<i class="fas fa-percentage"></i>
							</div>
							<div class="stat-info">
								<h4>Occupancy Rate</h4>
								<div class="stat-value">{{ occupancy_rate ?? 0 }}%</div>
							</div>
						</div>
						<div class="stat-card">
							<div class="stat-icon">
								<i class="fas fa-calendar-check"></i>
							</div>
							<div class="stat-info">
								<h4>Active Reservations</h4>
								<div class="stat-value">{{ active_reservations ?? 0 }}</div>
							</div>
						</div>
						<div class="stat-card">
							<div class="stat-icon">
								<i class="fas fa-money-bill-wave"></i>
							</div>
							<div class="stat-info">
								<h4>Today's Revenue</h4>
								<div class="stat-value">{{ daily_revenue ?? 0 }}
									TND</div>
							</div>
						</div>
						<div class="stat-card">
							<div class="stat-icon">
								<i class="fas fa-chart-line"></i>
							</div>
							<div class="stat-info">
								<h4>Monthly Revenue</h4>
								<div class="stat-value">{{ monthly_revenue ?? 0 }}
									TND</div>
							</div>
						</div>
					</div>

					{# Floor Stats Card #}
					<div class="panel-card">
						<div class="card-header">
							<h3>Floor Statistics</h3>
						</div>
						<div class="card-body">
							{% if floor_stats is defined and floor_stats|length > 0 %}
								<div class="table-responsive">
									<table class="data-table">
										<thead>
											<tr>
												<th>Floor</th>
												<th>Total Spots</th>
												<th>Available</th>
												<th>Occupied</th>
												<th>Occupancy Rate</th>
											</tr>
										</thead>
										<tbody>
											{% for floor_stat in floor_stats %}
												<tr>
													<td>{{ floor_stat.floor }}</td>
													<td>{{ floor_stat.total }}</td>
													<td>{{ floor_stat.available }}</td>
													<td>{{ floor_stat.occupied }}</td>
													<td>
														<div class="progress-bar">
															<div class="progress" style="width: {{ floor_stat.occupancy_rate }}%"></div>
															<span>{{ floor_stat.occupancy_rate }}%</span>
														</div>
													</td>
												</tr>
											{% endfor %}
										</tbody>
									</table>
								</div>
							{% else %}
								<div class="empty-state">
									<i class="fas fa-chart-area"></i>
									<p>No floor statistics available.</p>
								</div>
							{% endif %}
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	{# Modals #}
	{# Add Spot Modal #}
	<div id="addSpotModal" class="modal">
		<div class="modal-content">
			<div class="modal-header">
				<h2>
					<i class="fas fa-plus-circle"></i>
					Add New Parking Spot</h2>
				<span class="close-modal" onclick="closeModal('addSpotModal')">&times;</span>
			</div>
			<div class="modal-body">
				<form id="addSpotForm" onsubmit="addNewSpot(event)">
					<div class="form-group">
						<label for="spotZone">Zone</label>
						<input type="text" id="spotZone" required placeholder="Enter zone (e.g., A, B, C)" pattern="[A-Za-z]" title="Single letter only">
					</div>

					<div class="form-group">
						<label for="spotFloor">Floor</label>
						<select id="spotFloor" required>
							<option value="1">Floor 1</option>
							<option value="2">Floor 2</option>
							<option value="3">Floor 3</option>
						</select>
					</div>

					<div class="form-actions">
						<button type="button" class="btn-secondary" onclick="closeModal('addSpotModal')">Cancel</button>
						<button type="submit" class="btn-primary">
							<i class="fas fa-check"></i>
							Create Spot
						</button>
					</div>
				</form>
			</div>
		</div>
	</div>


	{# Edit Reservation Modal #}
	<div id="editReservationModal" class="modal">
		<div class="modal-content">
			<div class="modal-header">
				<h2>
					<i class="fas fa-edit"></i>
					Edit Reservation</h2>
				<span class="close-modal" onclick="closeModal('editReservationModal')">&times;</span>
			</div>
			<div class="modal-body">
				<form id="editReservationForm" onsubmit="updateReservation(event)">
					<input type="hidden" id="editReservationId">

					<div class="form-group">
						<label for="editReservationStart">Start Time</label>
						<input type="datetime-local" id="editReservationStart" required>
					</div>

					<div class="form-group">
						<label for="editReservationEnd">End Time</label>
						<input type="datetime-local" id="editReservationEnd" required>
					</div>

					<div class="form-group">
						<label for="editReservationStatus">Status</label>
						<select id="editReservationStatus" required>
							<option value="active">Active</option>
							<option value="expired">Expired</option>
							<option value="cancelled">Cancelled</option>
						</select>
					</div>

					<div class="form-actions">
						<button type="button" class="btn-secondary" onclick="closeModal('editReservationModal')">Cancel</button>
						<button type="submit" class="btn-primary">
							<i class="fas fa-save"></i>
							Save Changes
						</button>
					</div>
				</form>
			</div>
		</div>
	</div>
{% endblock %}

{% block javascripts %}
	{{ parent() }}
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
	<script>
		// Initialize DataTables
$(document).ready(function () {
$('#spotsTable').DataTable();
$('#reservationsTable').DataTable();

// Set up sidebar tab navigation
document.querySelectorAll('.nav-item').forEach(item => {
item.addEventListener('click', function () { // Deactivate all tabs and panels
document.querySelectorAll('.nav-item').forEach(tab => tab.classList.remove('active'));
document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));

// Activate clicked tab and corresponding panel
this.classList.add('active');
const targetPanel = this.getAttribute('data-tab');
document.getElementById(targetPanel).classList.add('active');
});
});

// Set up floor buttons
document.querySelectorAll('.floor-btn').forEach(btn => {
btn.addEventListener('click', function () {
document.querySelectorAll('.floor-btn').forEach(b => b.classList.remove('active'));
this.classList.add('active');
});
});

// Load initial floor data
loadFloorSpots(1);
});

// Modal functions
function openModal(modalId) {
document.getElementById(modalId).style.display = 'flex';
setTimeout(() => {
document.getElementById(modalId).classList.add('active');
}, 10);
}

function closeModal(modalId) {
document.getElementById(modalId).classList.remove('active');
setTimeout(() => {
document.getElementById(modalId).style.display = 'none';
}, 300);
}


function addNewSpot(event) {
event.preventDefault();

const zone = document.getElementById('spotZone').value.toUpperCase();
const floor = document.getElementById('spotFloor').value;
const floorValue = 'Level ' + floor;

fetch('/admin/parking/add-spot', {
method: 'POST',
headers: {
'Content-Type': 'application/json',
'Accept': 'application/json'
},
body: JSON.stringify(
{zone: zone, floor: floorValue, statut: 'free'}
)
}).then(response => response.json()).then(data => {
if (data.success) {
showNotification('Spot added successfully! Zone ' + zone + ' on Floor ' + floor + ' is now available.', 'success');
closeModal('addSpotModal');
loadFloorSpots(floor);
} else {
showNotification('Error: ' + (
data.message || 'Failed to add spot'
), 'error');
}
}).catch(error => {
console.error('Error:', error);
showNotification('Failed to add spot: ' + error.message, 'error');
});
}



// Load spots for selected floor
function loadFloorSpots(floor) {
fetch (`/admin/parking/floor/${floor}`).then(response => {
if (!response.ok) {
throw new Error('Network response was not ok');
}
return response.json();
}).then(data => {
document.getElementById('currentFloorDisplay').textContent = floor;

const table = $('#spotsTable').DataTable();
table.clear().destroy();

$('#spotsTable').DataTable({
responsive: true,
    data: data.spots.map(spot => [
        spot.zone + spot.id,
        spot.zone,
        spot.floor.replace('Level ', ''),
        `<span class="status-badge ${spot.statut}">${spot.statut.charAt(0).toUpperCase() + spot.statut.slice(1)}</span>`,
        `<div class="action-buttons">
            <a href="/admin/parking/edit/${spot.id}" class="btn-edit">
                <i class="fas fa-edit"></i>
            </a>
            <a href="/admin/parking/delete/${spot.id}" class="btn-delete" onclick="return confirm('Are you sure?')">
                <i class="fas fa-trash"></i>
            </a>
        </div>`
]),
language: {
search: "Search spots:",
lengthMenu: "Show _MENU_ spots per page",
info: "Showing _START_ to _END_ of _TOTAL_ spots",
paginate: {
first: "First",
last: "Last",
next: "Next",
previous: "Previous"
}
}
});
}).catch(error => {
console.error('Error loading floor spots:', error);
showNotification('Failed to load spots for this floor', 'error');
});
}

function editReservation(reservationId) {
    window.location.href = `/admin/reservation/edit/${reservationId}`;
}
function updateReservation(event) {
event.preventDefault();
const reservationId = document.getElementById('editReservationId').value;
const startTime = document.getElementById('editReservationStart').value;
const endTime = document.getElementById('editReservationEnd').value;
const status = document.getElementById('editReservationStatus').value;

fetch (`/admin/reservation/update/${reservationId}`, {
method: 'POST',
headers: {
'Content-Type': 'application/json'
},
body: JSON.stringify(
{startTime, endTime, status}
)
}).then(response => response.json()).then(data => {
if (data.success) {
showNotification('Reservation updated successfully!', 'success');
closeModal('editReservationModal');
location.reload();
} else {
showNotification('Error: ' + data.message, 'error');
}
}).catch(error => {
console.error('Error:', error);
showNotification('An error occurred while updating the reservation', 'error');
});
}



// Notification system
function showNotification(message, type = 'info') {
const notification = document.createElement('div');
notification.className = `notification ${type}`;
notification.innerHTML = `
                <i class="fas ${
type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'
}"></i>
                ${message}
            `;

document.body.appendChild(notification);

// Show notification
setTimeout(() => {
notification.style.opacity = '1';
notification.style.transform = 'translateY(0)';
}, 10);

// Auto-hide after 5 seconds
setTimeout(() => {
notification.style.opacity = '0';
notification.style.transform = 'translateY(-20px)';
setTimeout(() => notification.remove(), 300);
}, 5000);
}
	</script>
{% endblock %}
