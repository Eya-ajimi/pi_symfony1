{% extends "maria_templates/base.html.twig" %}

{% block title %}Product Management
{% endblock %}

{% block stylesheets %}
	{{ parent() }}
	<!-- Add Font Awesome for icons -->
	<link
	rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
<!-- Include our custom CSS -->
{% endblock %}

{% block body %}
	<div
		class="dashboard-container">
		<!-- Combined Header Container -->
		<div
			class="dashboard-header">
			<!-- Search Bar (now moved inside dashboard-header) -->
			<div class="search-container">
				<input type="text"  placeholder="Search products by name or description...">
				<i class="fas fa-search"></i>
			</div>

			<!-- Add Product Button -->
			<div class="addbutton-container">
				<button id="addProductBtn" class="btn btn-add" onclick="openAddModal()">
					<i class="fas fa-plus"></i>
					Add Product
				</button>
			</div>
		</div>

		 <div class="product-grid">
    {% for p in products %}
        <div class="product-card" data-product-name="{{p.nom|lower}}" data-product-description="{{p.description|lower|default('')}}">
            {% if p.discount %}
                <div class="discount-badge">{{p.getDiscountPercentage()}}% OFF</div>
            {% endif %}
            
            <div class="product-image">
                {% if p.image_url %}
                    <img src="{{asset(p.image_url)}}" alt="{{p.nom}}">
                {% else %}
                    <img src="{{asset('resources/assets/buy.png')}}" alt="Default product image">
                {% endif %}
            </div>
            
            <div class="product-body">
                <h5 class="product-title">{{p.nom}}</h5>
                <p class="product-description">{{p.description|default('No description available')}}</p>
                
                <div class="product-pricing">
                    <div class="price-container">
                        {% if p.discount %}
                            <span class="original-price">${{p.prix}}</span>
                            <span class="discounted-price">${{p.getDiscountedPrice()}}</span>
                            <span class="discount-percentage">({{p.getDiscountPercentage()}}% OFF)</span>
                        {% else %}
                            <span class="product-price">${{p.prix}}</span>
                        {% endif %}
                    </div>
                </div>
                
                <div class="product-meta">
                    <span class="product-stock">Stock: {{p.stock}}</span>
                    <span class="product-likes"><i class="fas fa-heart"></i> {{p.likeCount|default(0)}}</span>
                </div>
                
                <div class="product-actions">
                    <button class="btn btn-edit" onclick="openEditModal({{p.id}})">
                        <i class="fas fa-edit"></i>Edit
                    </button>
                    <button class="btn btn-remove" onclick="confirmRemove({{p.id}})">
                        <i class="fas fa-trash"></i>Remove
                    </button>
                </div>
            </div>
        </div>
    {% else %}
        <div class="empty-state">
            <i class="fas fa-box-open"></i>
            <p>No products found for your shop.</p>
            <button class="btn btn-primary mt-3" onclick="openAddModal()">
                <i class="fas fa-plus"></i>Add Your First Product
            </button>
        </div>
    {% endfor %}
</div>
	</div>

	<!-- Add Product Modal -->
	<div class="modal-background" id="addModal">
		<div class="modal-content">
			<div class="modal-header">
				<h3>Add New Product</h3>
				<button class="modal-close" onclick="closeAddModal()">&times;</button>
			</div>
			<div class="modal-body">
				<form id="addProductForm">
					<div class="form-group">
						<label for="newProductName">Product Name</label>
						<input type="text" id="newProductName" name="nom" class="form-control" required>
					</div>

					<div class="form-group">
						<label for="newProductDescription">Description</label>
						<textarea id="newProductDescription" name="description" class="form-control" rows="3"></textarea>
					</div>

					<div class="form-group">
						<label for="newProductPrice">Price ($)</label>
						<input type="number" step="0.01" id="newProductPrice" name="prix" class="form-control" required>
					</div>

					<div class="form-group">
						<label for="newProductStock">Stock</label>
						<input type="number" id="newProductStock" name="stock" class="form-control" required>
					</div>

					<div class="form-group">
						<label for="newProductDiscountPercentage">Discount (%)</label>
						<input type="number" id="newProductDiscountPercentage" name="discountPercentage" class="form-control" min="0" max="100" value="0">
						<small class="form-text text-muted">Enter the discount percentage (0-100). Leave at 0 for no discount.</small>
					</div>

					<div class="form-group">
						<label for="newProductImage">Product Image</label>
						<div class="custom-file-upload">
							<input type="file" id="newProductImage" name="image" class="form-control-file" accept="image/*">
							<div class="file-upload-preview">
								<i class="fas fa-cloud-upload-alt"></i>
								<span>Choose an image or drag it here</span>
							</div>
						</div>
					</div>
				</form>
			</div>
			<div class="modal-footer">
				<button class="btn btn-secondary" onclick="closeAddModal()">Cancel</button>
				<button class="btn btn-primary" onclick="saveNewProduct()">Add Product</button>
			</div>
		</div>
	</div>

	<!-- Edit Product Modal -->
	<div class="modal-background" id="editModal">
		<div class="modal-content">
			<div class="modal-header">
				<h3>Edit Product</h3>
				<button class="modal-close" onclick="closeEditModal()">&times;</button>
			</div>
			<div class="modal-body">
				<form id="editProductForm">
					<input type="hidden" id="productId" name="id">

					<div class="form-group">
						<label for="productName">Product Name</label>
						<input type="text" id="productName" name="nom" class="form-control" required>
					</div>

					<div class="form-group">
						<label for="productDescription">Description</label>
						<textarea id="productDescription" name="description" class="form-control" rows="3"></textarea>
					</div>

					<div class="form-group">
						<label for="productPrice">Price ($)</label>
						<input type="number" step="0.01" id="productPrice" name="prix" class="form-control" required>
					</div>

					<div class="form-group">
						<label for="productStock">Stock</label>
						<input type="number" id="productStock" name="stock" class="form-control" required>
					</div>

					<div class="form-group">
						<label for="productDiscountPercentage">Discount (%)</label>
						<input type="number" id="productDiscountPercentage" name="discountPercentage" class="form-control" min="0" max="100">
						<small class="form-text text-muted">Enter the discount percentage (0-100). Leave empty for no discount.</small>
					</div>

					<div class="form-group">
						<label for="productImage">Product Image</label>
						<div class="custom-file-upload">
							<input type="file" id="productImage" name="image" class="form-control-file" accept="image/*">
							<div class="file-upload-preview">
								<i class="fas fa-cloud-upload-alt"></i>
								<span>Choose a new image or drag it here</span>
							</div>
						</div>
					</div>
				</form>
			</div>
			<div class="modal-footer">
				<button class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
				<button class="btn btn-primary" onclick="saveProduct()">Save Changes</button>
			</div>
		</div>
	</div>
{% endblock %}

{% block javascripts %}
	{{ parent() }}
	<script>
		// Search functionality
document.getElementById('productSearch').addEventListener('input', function () {
const searchTerm = this.value.toLowerCase();
const products = document.querySelectorAll('.product-card');

products.forEach(product => {
const productName = product.dataset.productName;
const productDescription = product.dataset.productDescription;

if (productName.includes(searchTerm) || productDescription.includes(searchTerm)) {
product.style.display = '';
} else {
product.style.display = 'none';
}
});
});

// Add Product Modal functions
function openAddModal() {
document.getElementById('addModal').classList.add('active');
}

function closeAddModal() {
document.getElementById('addModal').classList.remove('active');
document.getElementById('addProductForm').reset();
}

function saveNewProduct() { // In a real application, you would handle the form submission to create a new product
alert('New product added successfully!');
closeAddModal();
// You would typically refresh the product list or add the new product to the DOM
}

// Edit Product Modal functions
function openEditModal(productId) {
// In a real application, you would fetch the product data from the server
// and populate the form fields with the product's current values
document.getElementById('productId').value = productId;

// Show modal
document.getElementById('editModal').classList.add('active');
}

function closeEditModal() {
document.getElementById('editModal').classList.remove('active');
}

function saveProduct() {
// You would handle form submission here
// For this example, we'll just close the modal
alert('Product changes saved!');
closeEditModal();
}

function confirmRemove(productId) {
if (confirm('Are you sure you want to remove this product?')) { // In a real application, you would send a request to delete the product
alert('Product removed!');
}
}

// File upload preview functionality
const fileInputs = document.querySelectorAll('input[type="file"]');
fileInputs.forEach(input => {
input.addEventListener('change', function () {
const preview = this.parentElement.querySelector('.file-upload-preview');
if (this.files && this.files[0]) {
const fileName = this.files[0].name;
preview.innerHTML = `<i class="fas fa-file-image"></i> <span>${fileName}</span>`;
preview.classList.add('has-file');
} else {
preview.innerHTML = `<i class="fas fa-cloud-upload-alt"></i> <span>Choose an image or drag it here</span>`;
preview.classList.remove('has-file');
}
});
});
	</script>
{% endblock %}
