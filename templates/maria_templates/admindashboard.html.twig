{# templates/dashboard/index.html.twig #}
{% extends "maria_templates/base.html.twig" %}

{% block title %}Shop Dashboard{% endblock %}

{% block javascripts %}
    {{ parent() }}
    {# Pass data to JavaScript #}
    <script>
        window.ratingDistribution = {{ ratingDistribution|json_encode|raw }};
        window.salesData = {{ salesData|default(null)|json_encode|raw }};
    </script>

    {# Initialize charts #}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/path/to/dashboard.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            console.log('Rating data:', window.ratingDistribution);

            if (document.getElementById('ratingsChart')) {
                initRatingsChart();
            }
            if (document.getElementById('salesChart')) {
                initSalesChart();
            }
        });
    </script>
{% endblock %}

{% block body %}
<div class="dashboard-container">
    <div class="main-content">

        <div class="dashboard-stats">
            <div class="stat-card client-of-month" style="justify-content:center">
                <div class="stat-icon">
                    <i class="fas fa-trophy"></i>
                </div>
                <div class="stat-info">
                    <h3>Client of the Month</h3>
                    <div class="client-info">
                        <img src="{{ asset('images/user.JPG') }}" alt="Client" class="client-avatar">
                        <div class="client-details">
                            <h4>Mariem Ammari</h4>
                        </div>
                    </div>
                </div>
            </div>

            <div class="stat-card average-rating">
                <div class="stat-icon">
                    <i class="fas fa-star"></i>
                </div>
                <div class="stat-info">
                    <h3>Average Rating</h3>
                    <div class="rating-display">
                        <span class="rating-value">{{ averageRating|number_format(1) }}</span>
                        <div class="star-rating">
                            {% for i in 1..5 %}
                                {% if averageRating >= i %}
                                    <i class="fas fa-star"></i>
                                {% elseif averageRating > (i - 0.8) %}
                                    <i class="fas fa-star-half-alt"></i>
                                {% else %}
                                    <i class="far fa-star"></i>
                                {% endif %}
                            {% endfor %}
                        </div>
                        <span class="rating-count">({{ ratingCount }} reviews)</span>
                    </div>
                </div>
            </div>

            <div class="stat-card product-count">
                <div class="stat-icon">
                    <i class="fas fa-box"></i>
                </div>
                <div class="stat-info">
                    <h3>Total Products</h3>
                    <div class="product-stats">
                        <h2>{{ productCount }}</h2>
                    </div>
                </div>
            </div>
        </div>

        <div class="dashboard-main-content">
            <div class="content-section top-products">
                <div class="section-header">
                    <h2>Top Liked Products</h2>
                    <a href="{{ path('products') }}" class="view-all">View All</a>
                </div>
                <div class="products-grid">
                    {% for product in topLikedProducts %}
                        <div class="product-card">
                            <div class="product-image">
                                {% if product.image_url %}
                                    <img src="{{ asset(product.image_url) }}" alt="{{ product.nom }}">
                                {% else %}
                                    <img src="{{ asset('images/default-product.jpg') }}" alt="Default product image">
                                {% endif %}
                            </div>
                            <div class="product-info">
                                <h4>{{ product.nom }}</h4>
                                <div class="product-meta">
                                    <span class="product-price">
                                        {% if product.promotionId %}
                                            <span class="original-price">{{ product.prix }} DT</span>
                                            <span class="discounted-price">{{ product.getDiscountedPrice() }} DT</span>
                                        {% else %}
                                            {{ product.prix }} DT
                                        {% endif %}
                                    </span>
                                    <span class="product-likes">
                                        <i class="fas fa-heart"></i>
                                        {{ product.likeCount ?? 0 }}
                                    </span>
                                </div>
                                <div class="product-stock
                                    {% if product.stock == 0 %} out-of-stock
                                    {% elseif product.stock < 10 %} low-stock
                                    {% else %} in-stock
                                    {% endif %}">
                                    {% if product.stock > 0 %}
                                        {% if product.stock < 10 %}
                                            Low Stock ({{ product.stock }})
                                        {% else %}
                                            In Stock ({{ product.stock }})
                                        {% endif %}
                                    {% else %}
                                        Out of Stock
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="no-products">
                            <p>No products found</p>
                        </div>
                    {% endfor %}
                </div>
            </div>

            <div class="charts-container">
                <div class="chart-section ratings-chart">
                    <div class="section-header">
                        <h2>Ratings Distribution</h2>
                    </div>
                    <div class="chart-container">
                        <canvas id="ratingsChart"></canvas>
                    </div>
                </div>

                <div class="chart-section sales-chart">
                    <div class="section-header">
                        <h2>Product Sales</h2>
                    </div>
                    <div class="chart-container">
                        <canvas id="salesChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="content-section stock-status">
                <div class="section-header">
                    <h2>Stock Status</h2>
                </div>
                <div class="stock-tabs">
                    <button class="tab-button active" data-tab="low-stock">
                        Low Stock ({{ lowStockProducts|length }})
                    </button>
                    <button class="tab-button" data-tab="out-of-stock">
                        Out of Stock ({{ outOfStockProducts|length }})
                    </button>
                </div>

                <div class="tab-content active" id="low-stock">
                    <table class="stock-table">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Current Stock</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for product in lowStockProducts %}
                                <tr>
                                    <td>
                                        <div class="product-cell">
                                            {% if product.image_url %}
                                                <img src="{{ asset(product.image_url) }}" alt="{{ product.nom }}">
                                            {% else %}
                                                <img src="{{ asset('images/default-product.jpg') }}" alt="Default product image">
                                            {% endif %}
                                            <span>{{ product.nom }}</span>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="stock-count low">{{ product.stock }}</span>
                                    </td>
                                    <td>
                                        <button class="restock-btn">Restock</button>
                                    </td>
                                </tr>
                            {% else %}
                                <tr>
                                    <td colspan="3" class="text-center">No products with low stock</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <div class="tab-content" id="out-of-stock">
                    <table class="stock-table">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for product in outOfStockProducts %}
                                <tr>
                                    <td>
                                        <div class="product-cell">
                                            {% if product.image_url %}
                                                <img src="{{ asset(product.image_url) }}" alt="{{ product.nom }}">
                                            {% else %}
                                                <img src="{{ asset('images/default-product.jpg') }}" alt="Default product image">
                                            {% endif %}
                                            <span>{{ product.nom }}</span>
                                        </div>
                                    </td>
                                    <td>
                                        <button class="restock-btn urgent">Restock</button>
                                    </td>
                                </tr>
                            {% else %}
                                <tr>
                                    <td colspan="2" class="text-center">No out-of-stock products</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>
</div>
{% endblock %}
