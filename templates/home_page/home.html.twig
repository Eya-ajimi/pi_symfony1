{% extends 'base.html.twig' %}

{% block title %}Home - InnoMall{% endblock %}

{# Include home.css & home.js only for this page #}
{% block stylesheets %}
    <link rel="stylesheet" href="{{ asset('css/home.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha512-..." crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        .user-owned {
            border-left: 3px solidrgb(209, 228, 209);
            padding-left: 5px;
        }
        .post-header, .comment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .post-options, .comment-options, .scomment-options {
            cursor: pointer;
            padding: 5px;
        }
        .no-options {
            color: #ccc;
            cursor: not-allowed;
        }
    </style>
{% endblock %}

{% block javascripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Function to close all post menus
        const closeAllPostMenus = () => {
            document.querySelectorAll('.post-menu').forEach(menu => {
                menu.classList.remove('visible');
            });
        };

        // Function to close all comment menus
        const closeAllCommentMenus = () => {
            document.querySelectorAll('.comment-menu').forEach(menu => {
                menu.style.display = 'none';
            });
        };

        // Post options menu handling
        document.querySelectorAll('.post-options').forEach(optionBtn => {
            optionBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                const menu = this.nextElementSibling;
                
                // Close all other menus before opening this one
                closeAllPostMenus();
                closeAllCommentMenus();
                menu.classList.toggle('visible');
            });
        });

        // Comment options menu handling
        document.querySelectorAll('.comment-options').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                const menu = this.nextElementSibling;
                
                // Close all other menus before opening this one
                closeAllPostMenus();
                closeAllCommentMenus();
                menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
            });
        });

        // Reply options menu handling
        document.querySelectorAll('.scomment-options').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                const menu = this.nextElementSibling;
                
                // Close all other menus before opening this one
                closeAllPostMenus();
                closeAllCommentMenus();
                menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
            });
        });

        // Toggle reply form visibility
        function toggleReplyForm(commentId) {
            const form = document.getElementById(`reply-form-${commentId}`);
            form.style.display = form.style.display === 'none' ? 'block' : 'none';
        }

        // Close all menus when clicking elsewhere
        document.addEventListener('click', function() {
            closeAllPostMenus();
            closeAllCommentMenus();
        });

        // Prevent closing when clicking inside menus
        document.querySelectorAll('.post-menu, .comment-menu').forEach(menu => {
            menu.addEventListener('click', function(e) {
                e.stopPropagation();
            });
        });
    });
</script>
{% endblock %}

{% block content %}
<div class="container">
    <!-- Left Section: Chatbot Placeholder -->
    <aside class="left-section">
        Chatbot Section (Coming Soon)
    </aside>

    <!-- Middle Section: Posts -->
    <div class="container">
        <section class="middle-section">
            {# Post Creation Form #}
            <div class="create-post">
                {{ form_start(postForm, {
                    'action': path('app_home_page'),
                    'attr': {
                        'class': 'post-form',
                        'novalidate': 'novalidate',
                        'name': 'post_form'
                    }
                }) }}

                <div class="form-group input-wrapper">
                    {{ form_widget(postForm.contenu, {
                        'attr': {
                            'class': 'custom-textarea-rect',
                        }
                    }) }}

                    <button type="submit" class="post-btn">Post</button>

                    {# Display post form validation errors here #}
                    {% for error in postForm.contenu.vars.errors %}
                        <div class="tooltip-error">{{ error.message }}</div>
                    {% endfor %}
                </div>

                {{ form_end(postForm) }}
            </div>

            <br/>
            <br/>

            {% for post in posts %}
            <div class="post-card {% if post.utilisateur == app.user %}user-owned{% endif %}">
                <div class="post-header">
                    <div class="user-info">
                        <span><i class="fas fa-user"></i></span>
                        <div class="user-details">
                            <span class="user-name">{{ post.utilisateur.nom }}</span>
                            <span class="post-time">{{ post.dateCreation|date('H:i') }}</span>
                        </div>
                    </div>
                    
                    {% if post.utilisateur == app.user %}
                        <span class="post-options">⋮</span>
                        <div class="post-menu">
                            <a href="{{ path('app_home_page', {'edit': post.id}) }}" class="edit-post">
                                <i class="fas fa-edit" style="color: grey;"></i> Edit
                            </a>
                            <a href="{{ path('post_delete', {id: post.id}) }}" 
                               onclick="return confirm('Êtes-vous sûr de vouloir supprimer ce post ?')">
                                <i class="fas fa-trash-alt" style="color: red;"></i> Delete
                            </a>
                        </div>
                    {% else %}
                        <span class="no-options" title="You can only edit your own posts">⋮</span>
                    {% endif %}
                </div>

                <div class="post-content">
                    {% if edit_post_id == post.id %}
                        <form method="POST">
                            <input type="hidden" name="post_id" value="{{ post.id }}">
                            <textarea name="content" class="edit-textarea">{{ post.contenu }}</textarea>
                            <div class="edit-actions">
                                <button type="submit" class="save-btn">Save</button>
                                <a href="{{ path('app_home_page') }}" class="cancel-btn">Cancel</a>
                            </div>
                        </form>
                    {% else %}
                        {{ post.contenu }}
                    {% endif %}
                </div>

                <div class="post-actions">
                    <button class="like-btn">Like</button>
                    <button class="comment-btn">Comment</button>
                </div>

                <!-- Comment Section -->
                <div class="comment-section">
                    {% for comment in post.commentaires %}
                    <div class="comment {% if comment.utilisateur == app.user %}user-owned{% endif %}">
                        <span><i class="fas fa-user"></i></span>
                        <div class="comment-body">
                            <div class="comment-header">
                                <span class="comment-user">{{ comment.utilisateur.nom }}</span>
                                <span class="comment-time">{{ comment.dateCreation|date('H:i') }}</span>
                                
                                {% if comment.utilisateur == app.user %}
                                    <span class="comment-options">⋮</span>
                                    <div class="comment-menu">
                                        <a href="{{ path('app_home_page', {'edit_comment': comment.id}) }}" class="edit-comment">
                                            <i class="fas fa-edit" style="color: grey;"></i> Edit
                                        </a>
                                        <a href="{{ path('comment_delete', {'id': comment.id}) }}" 
                                           onclick="return confirm('Êtes-vous sûr de vouloir supprimer ce commentaire ?')">
                                            <i class="fas fa-trash-alt" style="color: red;"></i> Delete
                                        </a>
                                    </div>
                                {% else %}
                                    <span class="no-options" title="You can only edit your own comments">⋮</span>
                                {% endif %}
                            </div>
                            
                            {% if edit_comment_id == comment.id %}
                                <form method="POST" action="{{ path('app_home_page') }}" class="edit-comment-form">
                                    <input type="hidden" name="comment_id" value="{{ comment.id }}">
                                    <textarea name="comment_content" class="edit-comment-textarea">{{ comment.contenu }}</textarea>
                                    <div class="edit-comment-actions">
                                        <button type="submit" class="save-comment-btn">Save</button>
                                        <a href="{{ path('app_home_page') }}" class="cancel-comment-btn">Cancel</a>
                                    </div>
                                </form>
                            {% else %}
                                <div class="comment-text">{{ comment.contenu }}</div>
                            {% endif %}
                            
                            <div class="comment-actions">
                                <button class="like-btn">Like</button>
                                <button class="reply-btn" onclick="toggleReplyForm({{ comment.id }})">Reply</button>
                            </div>

                            <!-- Hidden reply form -->
                            <div class="add-reply">
                                {{ form_start(replyForms[comment.id], { 'attr': {'class': 'reply-form', 'novalidate': 'novalidate'} }) }}
                                <div class="input-wrapper" style="width:450px">
                                    {{ form_widget(replyForms[comment.id].contenu, {'attr': {
                                        'class': 'custom-textarea',
                                        'data-error-target': 'input'
                                    }}) }}
                                    <button type="submit" class="send-btn">➤</button>

                                    {% for error in replyForms[comment.id].contenu.vars.errors %}
                                        <div class="tooltip-error">{{ error.message }}</div>
                                    {% endfor %}
                                </div>

                                <input type="hidden" name="reply_comment_id" value="{{ comment.id }}">
                                {{ form_end(replyForms[comment.id]) }}
                            </div>
                            
                            <!-- Reply Section -->
                            {% for reply in comment.sousCommentaires %}
                            <div class="reply {% if reply.utilisateur == app.user %}user-owned{% endif %}">
                                <span><i class="fas fa-user"></i></span>
                                <div class="comment-body">
                                    <div class="comment-header">
                                        <span class="comment-user">{{ reply.utilisateur.nom }}</span>
                                        <span class="comment-time">{{ reply.dateCreation|date('H:i') }}</span>
                                        
                                        {% if reply.utilisateur == app.user %}
                                            <span class="scomment-options">⋮</span>
                                            <div class="comment-menu">
                                                <a href="{{ path('app_home_page', {'edit_reply': reply.id}) }}" class="edit-comment">
                                                    <i class="fas fa-edit" style="color: grey;"></i> Edit
                                                </a>
                                                <a href="{{ path('delete_reply', {'id': reply.id}) }}" 
                                                   onclick="return confirm('Êtes-vous sûr de vouloir supprimer ce sous commentaire ?')">
                                                    <i class="fas fa-trash-alt" style="color: red;"></i> Delete
                                                </a>
                                            </div>
                                        {% else %}
                                            <span class="no-options" title="You can only edit your own replies">⋮</span>
                                        {% endif %}
                                    </div>
                                    
                                    {% if edit_reply_id == reply.id %}
                                        <form method="POST" action="{{ path('app_home_page') }}" class="edit-comment-form">
                                            <input type="hidden" name="reply_id" value="{{ reply.id }}">
                                            <textarea name="reply_content" class="edit-comment-textarea">{{ reply.contenu }}</textarea>
                                            <div class="edit-comment-actions">
                                                <button type="submit" class="save-comment-btn">Save</button>
                                                <a href="{{ path('app_home_page') }}" class="cancel-comment-btn">Cancel</a>
                                            </div>
                                        </form>
                                    {% else %}
                                        <div class="comment-text">{{ reply.contenu }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <!-- Add Comment Box -->
                <div class="add-comment">
                    {{ form_start(commentForms[post.id], { 'attr': {'class': 'comment-form', 'novalidate': 'novalidate'} }) }}

                    <div class="input-wrapper">
                        {{ form_widget(commentForms[post.id].contenu, {'attr': {
                            'class': 'custom-textarea',
                            'data-error-target': 'input' 
                        }}) }}
                        <button type="submit" class="send-btn">➤</button>

                        {% for error in commentForms[post.id].contenu.vars.errors %}
                            <div class="tooltip-error">{{ error.message }}</div>
                        {% endfor %}
                    </div>

                    <input type="hidden" name="comment_post_id" value="{{ post.id }}">

                    {{ form_end(commentForms[post.id]) }}
                </div>
            </div>
            {% endfor %}
        </section>
    </div>

    <!-- Right Section: Mall Map & ATMs -->
    <aside class="right-section">
        <div class="mall-map">
            <img src="{{ asset('logo/mall.jpg') }}" alt="Mall Map">
        </div>
             
        <div class="atm-section">
            <h3><i class="fas fa-money-check-alt me-2 text-primary"></i>ATM Status Dashboard</h3>

            {% if atms is not empty %}
                <table class="atm-table">
                    <thead>
                        <tr>
                            <th><i class="fas fa-building-columns me-1"></i>Bank Name</th>
                            <th><i class="fas fa-map-marker-alt me-1"></i>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for atm in atms %}
                            <tr>
                                <td>{{ atm.bankName|capitalize }}</td>
                                <td>
                                    <span class="status-badge {{ atm.status == 'active' ? 'status-active' : 'status-inactive' }}">
                                        <i class="fas {{ atm.status == 'active' ? 'fa-check-circle' : 'fa-times-circle' }} me-1"></i>
                                        {{ atm.status }}
                                    </span>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p class="text-muted mt-3">No ATMs found.</p>
            {% endif %}
        </div>
    </aside>
</div>
{% endblock %}